<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
    <meta name="theme-color" content="#0b1426" />
    <title>Retro Arcade</title>

    <style>
      :root {
        --green: #00ff66;
        --green2: #00ffaa;
        --dim: rgba(0, 255, 102, 0.45);
        --panel: rgba(0, 10, 6, 0.35);
        --panel2: rgba(0, 10, 6, 0.55);
      }

      html,
      body {
        height: 100%;
        margin: 0;
        background: #000;
        color: var(--green);
        font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;

        overflow-x: hidden;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
      }

      body::before {
        content: "";
        position: fixed;
        inset: 0;
        pointer-events: none;
        background: linear-gradient(rgba(255, 255, 255, 0.03), rgba(0, 0, 0, 0.03));
        background-size: 100% 4px;
        mix-blend-mode: overlay;
        opacity: 0.35;
        z-index: 10;
      }

      body::after {
        content: "";
        position: fixed;
        inset: -20px;
        pointer-events: none;
        background:
          radial-gradient(circle at 50% 45%, rgba(0, 255, 170, 0.1), transparent 55%),
          radial-gradient(circle at 50% 60%, rgba(0, 0, 0, 0), rgba(0, 0, 0, 0.55) 70%);
        opacity: 0.9;
        z-index: 11;
        animation: crtFlicker 5.2s infinite;
      }

      @keyframes crtFlicker {
        0%, 100% { filter: brightness(1); }
        16% { filter: brightness(0.98); }
        17% { filter: brightness(1.05); }
        18% { filter: brightness(0.99); }
        52% { filter: brightness(1.02); }
        53% { filter: brightness(0.97); }
        54% { filter: brightness(1.01); }
      }

      .menu {
        min-height: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        text-align: center;
        padding: 88px 18px 28px;
        position: relative;
      }

      .topbar {
        position: fixed;
        top: 12px;
        left: 12px;
        right: 12px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        z-index: 20;
      }

      .pill {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 10px 12px;
        border: 1px solid var(--dim);
        border-radius: 999px;
        background: var(--panel);
        box-shadow: 0 0 10px rgba(0, 255, 102, 0.18);
        backdrop-filter: blur(6px);
        white-space: nowrap;
      }

      .pill small { opacity: 0.75; }

      .sound-btn {
        appearance: none;
        border: 1px solid var(--dim);
        border-radius: 999px;
        background: var(--panel2);
        color: var(--green);
        padding: 10px 12px;
        font: inherit;
        cursor: pointer;
        box-shadow: 0 0 10px rgba(0, 255, 102, 0.18);
        transition: transform 0.12s ease, box-shadow 0.12s ease, color 0.12s ease, border-color 0.12s ease;
        white-space: nowrap;
      }

      .sound-btn:hover {
        transform: translateY(-1px);
        color: var(--green2);
        border-color: var(--green2);
        box-shadow: 0 0 14px rgba(0, 255, 170, 0.45);
      }

      h1 {
        margin: 0 0 6px;
        font-size: 28px;
        text-shadow: 0 0 12px var(--green);
        z-index: 12;
      }

      .menu-subtitle {
        margin-bottom: 18px;
        opacity: 0.75;
        font-size: 14px;
        z-index: 12;
      }

      .menu-items {
        display: flex;
        flex-direction: column;
        gap: 12px;
        width: 100%;
        max-width: 380px;
        z-index: 12;
      }

      .retro-btn {
        position: relative;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;

        padding: 14px 16px 14px 38px;
        border: 1px solid var(--dim);
        border-radius: 12px;
        color: var(--green);
        text-decoration: none;
        font-size: 18px;
        background: rgba(0, 0, 0, 0.25);
        box-shadow: 0 0 8px rgba(0, 255, 102, 0.22);
        transition: all 0.12s ease;
      }

      .retro-btn::before {
        content: "‚ñ∂";
        position: absolute;
        left: 14px;
        opacity: 0;
        transform: translateX(-6px);
        transition: all 0.12s ease;
      }

      .retro-btn:hover,
      .retro-btn.active {
        transform: scale(1.03);
        color: var(--green2);
        border-color: var(--green2);
        box-shadow: 0 0 16px rgba(0, 255, 170, 0.55);
      }

      .retro-btn:hover::before,
      .retro-btn.active::before {
        opacity: 1;
        transform: translateX(0);
      }

      .label {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        min-width: 0;
      }

      .label span {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .best-badge {
        flex: 0 0 auto;
        font-size: 12px;
        letter-spacing: 0.12em;
        text-transform: uppercase;
        padding: 7px 10px;
        border-radius: 999px;
        border: 1px solid rgba(0, 255, 102, 0.35);
        background: rgba(0, 255, 102, 0.06);
        color: rgba(0, 255, 170, 0.9);
        box-shadow: 0 0 10px rgba(0, 255, 102, 0.12);
        white-space: nowrap;
      }

      .best-badge b { color: #eafff5; letter-spacing: 0.06em; }

      .menu-hint {
        margin-top: 18px;
        font-size: 12px;
        opacity: 0.65;
        max-width: 560px;
        z-index: 12;
      }

      @media (max-width: 480px) {
        .menu { padding: 72px 14px 26px; }
        .topbar { top: 10px; left: 10px; right: 10px; }

        .pill { padding: 8px 10px; font-size: 12px; gap: 8px; }
        .pill small, .pill span { display: none; }
        .pill::after { content: "üïπÔ∏è Arcade"; opacity: 0.9; }

        .sound-btn { padding: 8px 10px; font-size: 12px; }
        h1 { font-size: 22px; margin: 8px 0 4px; }
        .menu-subtitle { font-size: 12px; margin-bottom: 12px; }
        .menu-items { gap: 10px; max-width: 420px; }
        .retro-btn { font-size: 16px; padding: 12px 12px 12px 34px; }
        .best-badge { font-size: 11px; padding: 6px 9px; }
      }
    </style>
  </head>

  <body>
    <div class="menu" role="navigation" aria-label="Game selection menu">
      <div class="topbar">
        <div class="pill" aria-label="Arcade navigation hint">
          <small>Arcade Mode:</small>
          <span>‚Üë ‚Üì Select ¬∑ Enter Start</span>
        </div>
        <button id="soundBtn" class="sound-btn" type="button" aria-label="Toggle sound">
          üîä Sound: ON
        </button>
      </div>

      <h1>üéÆ Retro Game Hub</h1>
      <div class="menu-subtitle">Tap to play ¬∑ Keyboard supported ¬∑ CRT Mode enabled</div>

      <nav class="menu-items" id="menu">
        <a class="retro-btn" href="./flappy.html" data-id="flappy" data-best-key="flappy-best">
          <span class="label"><span>üê§ Flappy Bird</span></span>
          <span class="best-badge">BEST <b data-best-for="flappy">‚Äî</b></span>
        </a>

        <a class="retro-btn" href="./invaders.html" data-id="invaders" data-best-key="invaders-best">
          <span class="label"><span>üëæ Space Invaders</span></span>
          <span class="best-badge">BEST <b data-best-for="invaders">‚Äî</b></span>
        </a>

        <a class="retro-btn" href="./pacman.html" data-id="pacman" data-best-key="pacman-best">
          <span class="label"><span>·ó£ üëª Pac-Man</span></span>
          <span class="best-badge">BEST <b data-best-for="pacman">‚Äî</b></span>
        </a>

        <a class="retro-btn" href="./snake.html" data-id="snake" data-best-key="snake-best">
          <span class="label"><span>üêç Snake</span></span>
          <span class="best-badge">BEST <b data-best-for="snake">‚Äî</b></span>
        </a>

        <a class="retro-btn" href="./pong.html" data-id="pong" data-best-key="pong-best">
          <span class="label"><span>üèì Pong</span></span>
          <span class="best-badge">BEST <b data-best-for="pong">‚Äî</b></span>
        </a>

        <a class="retro-btn" href="./breakout.html" data-id="breakout" data-best-key="breakout-best">
          <span class="label"><span>üß± Breakout</span></span>
          <span class="best-badge">BEST <b data-best-for="breakout">‚Äî</b></span>
        </a>

        <a class="retro-btn" href="./tetris.html" data-id="tetris" data-best-key="tetris-best">
          <span class="label"><span>üßä Tetris</span></span>
          <span class="best-badge">BEST <b data-best-for="tetris">‚Äî</b></span>
        </a>

        <a class="retro-btn" href="./city.html" data-id="city" data-best-key="city-best">
          <span class="label"><span>üöó Neon City Driver</span></span>
          <span class="best-badge">BEST <b data-best-for="city">‚Äî</b></span>
        </a>

        <a class="retro-btn" href="./fruit.html" data-id="fruit" data-best-key="retro-neon-fruit-best">
          <span class="label"><span>üçâ Neon Fruit Ninja</span></span>
          <span class="best-badge">BEST <b data-best-for="fruit">‚Äî</b></span>
        </a>

        <a class="retro-btn" href="./defense.html" data-id="defense" data-best-key="defense-best">
          <span class="label"><span>üõ°Ô∏è Neon Tap Defense</span></span>
          <span class="best-badge">BEST <b data-best-for="defense">‚Äî</b></span>
        </a>

        <a class="retro-btn" href="./jumper.html" data-id="jumper" data-best-key="neon-sky-jumper-best">
          <span class="label"><span>üöÄ Neon Sky Jumper</span></span>
          <span class="best-badge">BEST <b data-best-for="jumper">‚Äî</b></span>
        </a>

        <a class="retro-btn" href="./beatdrop.html" data-id="beatdrop" data-best-key="beatdrop-best">
          <span class="label"><span>üéµ Neon Beat Drop</span></span>
          <span class="best-badge">BEST <b data-best-for="beatdrop">‚Äî</b></span>
        </a>
      </nav>

      <p class="menu-hint">
        If BEST is ‚Äú‚Äî‚Äù, it means the game saved a different key name. This menu now auto-detects many common keys.
      </p>
    </div>

    <script>
      // ===== Robust BEST detector (fixes your issue) =====

      function parseBestValue(raw) {
        if (raw == null) return null;

        // numeric
        const n = Number(raw);
        if (!Number.isNaN(n) && Number.isFinite(n)) return Math.floor(n);

        // JSON common fields
        try {
          const obj = JSON.parse(raw);
          if (obj && typeof obj.best === "number") return Math.floor(obj.best);
          if (obj && typeof obj.highScore === "number") return Math.floor(obj.highScore);
          if (obj && typeof obj.score === "number") return Math.floor(obj.score);
        } catch (_) {}

        return null;
      }

      function tryKeys(keys) {
        for (const k of keys) {
          if (!k) continue;
          const v = parseBestValue(localStorage.getItem(k));
          if (v != null) return { key: k, best: v };
        }
        return null;
      }

      function findBestForGame(id, primaryKey) {
        const common = [
          `${id}-best`,
          `${id}_best`,
          `${id}Best`,
          `${id}-highscore`,
          `${id}-highScore`,
          `${id}_highscore`,
          `${id}-score`,
          `${id}-bestScore`,
          `best-${id}`,
          `highscore-${id}`,
          `${id}-hiscore`,
        ];

        // 1) primary key from HTML + common patterns
        let hit = tryKeys([primaryKey, ...common]);
        if (hit) return hit;

        // 2) scan localStorage for something that includes the id + best/highscore
        const idLower = id.toLowerCase();
        const candidates = [];
        for (let i = 0; i < localStorage.length; i++) {
          const k = localStorage.key(i);
          if (!k) continue;
          const kl = k.toLowerCase();
          const looksRelated = kl.includes(idLower) && (kl.includes("best") || kl.includes("high") || kl.includes("score"));
          if (looksRelated) candidates.push(k);
        }

        // prioritize best-like keys first
        candidates.sort((a, b) => {
          const al = a.toLowerCase();
          const bl = b.toLowerCase();
          const aw = (al.includes("best") ? 3 : 0) + (al.includes("high") ? 2 : 0) + (al.includes("score") ? 1 : 0);
          const bw = (bl.includes("best") ? 3 : 0) + (bl.includes("high") ? 2 : 0) + (bl.includes("score") ? 1 : 0);
          return bw - aw;
        });

        hit = tryKeys(candidates);
        return hit; // may be null
      }

      const items = Array.from(document.querySelectorAll(".retro-btn"));
      const bestTargets = new Map();
      document.querySelectorAll("[data-best-for]").forEach((b) => {
        bestTargets.set(b.getAttribute("data-best-for"), b);
      });

      function refreshAllBest() {
        items.forEach((a) => {
          const id = a.dataset.id;
          const primaryKey = a.dataset.bestKey;
          const target = bestTargets.get(id);
          if (!target) return;

          const found = findBestForGame(id, primaryKey);
          target.textContent = found ? String(found.best) : "‚Äî";
        });
      }

      refreshAllBest();
      window.addEventListener("focus", refreshAllBest);

      // ===== Arcade navigation =====
      let index = 0;
      function updateActive() {
        items.forEach((el, i) => el.classList.toggle("active", i === index));
      }
      updateActive();

      // ===== WebAudio: BGM + SFX + mute toggle =====
      let audioReady = false;
      let audioCtx = null;
      let master = null;
      let bgmGain = null;
      let sfxGain = null;
      let bgmTimer = null;
      let soundOn = true;

      const soundBtn = document.getElementById("soundBtn");

      function ensureAudio() {
        if (audioReady) return;
        audioReady = true;

        const AC = window.AudioContext || window.webkitAudioContext;
        audioCtx = new AC();

        master = audioCtx.createGain();
        master.gain.value = 0.55;
        master.connect(audioCtx.destination);

        bgmGain = audioCtx.createGain();
        bgmGain.gain.value = 0.1;
        bgmGain.connect(master);

        sfxGain = audioCtx.createGain();
        sfxGain.gain.value = 0.25;
        sfxGain.connect(master);

        startBgm();
        applyMuteState();
      }

      function applyMuteState() {
        if (!master) return;
        master.gain.value = soundOn ? 0.55 : 0.0001;
        soundBtn.textContent = soundOn ? "üîä Sound: ON" : "üîá Sound: OFF";
      }

      function beep(freq, durMs, type = "square", gain = 0.12) {
        if (!audioCtx || !sfxGain || !soundOn) return;
        const t = audioCtx.currentTime;
        const o = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        o.type = type;
        o.frequency.value = freq;

        g.gain.setValueAtTime(0.0001, t);
        g.gain.exponentialRampToValueAtTime(gain, t + 0.01);
        g.gain.exponentialRampToValueAtTime(0.0001, t + durMs / 1000);

        o.connect(g);
        g.connect(sfxGain);

        o.start(t);
        o.stop(t + durMs / 1000 + 0.02);
      }

      function startBgm() {
        if (!audioCtx || !bgmGain) return;
        if (bgmTimer) clearInterval(bgmTimer);

        const scale = [220, 277.18, 329.63, 440, 554.37, 659.25];
        let step = 0;

        bgmTimer = setInterval(() => {
          if (!soundOn || !audioCtx) return;

          const t = audioCtx.currentTime;
          const freq = scale[step % scale.length];

          const o = audioCtx.createOscillator();
          const g = audioCtx.createGain();

          o.type = "triangle";
          o.frequency.setValueAtTime(freq, t);

          g.gain.setValueAtTime(0.0001, t);
          g.gain.exponentialRampToValueAtTime(0.06, t + 0.01);
          g.gain.exponentialRampToValueAtTime(0.0001, t + 0.18);

          const o2 = audioCtx.createOscillator();
          const g2 = audioCtx.createGain();
          o2.type = "sine";
          o2.frequency.setValueAtTime(freq * 2, t);
          g2.gain.setValueAtTime(0.0001, t);
          g2.gain.exponentialRampToValueAtTime(0.02, t + 0.01);
          g2.gain.exponentialRampToValueAtTime(0.0001, t + 0.18);

          o.connect(g); g.connect(bgmGain);
          o2.connect(g2); g2.connect(bgmGain);

          o.start(t); o.stop(t + 0.2);
          o2.start(t); o2.stop(t + 0.2);

          step++;
        }, 180);
      }

      soundBtn.addEventListener("click", () => {
        ensureAudio();
        soundOn = !soundOn;
        applyMuteState();
        beep(soundOn ? 880 : 220, 90, "square", 0.1);
      });

      const kickAudio = () => ensureAudio();
      window.addEventListener("pointerdown", kickAudio, { once: true });
      window.addEventListener("keydown", kickAudio, { once: true });

      window.addEventListener("keydown", (e) => {
        if (e.key === "ArrowDown") {
          index = (index + 1) % items.length;
          updateActive();
          ensureAudio();
          beep(660, 55, "square", 0.1);
        } else if (e.key === "ArrowUp") {
          index = (index - 1 + items.length) % items.length;
          updateActive();
          ensureAudio();
          beep(520, 55, "square", 0.1);
        } else if (e.key === "Enter") {
          ensureAudio();
          beep(880, 110, "square", 0.12);
          items[index].click();
        }
      });

      items.forEach((el, i) => {
        el.addEventListener("mouseenter", () => {
          index = i;
          updateActive();
        });

        el.addEventListener("click", () => {
          ensureAudio();
          beep(990, 120, "square", 0.12);
        });
      });
    </script>
  </body>
</html>
