<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover"/>
<meta name="theme-color" content="#020508"/>
<title>Neon Rift Split</title>
<style>
:root{--bg:#020508;--fg:#c9ffe1;--neon:#00ff66;--cyan:#00e5ff;--mag:#ff2bd6;--purp:#8b5cff;--gold:#ffcc33;--panel:rgba(0,10,6,.55);--panel2:rgba(0,10,6,.78);--line:rgba(0,255,102,.28)}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace;overscroll-behavior:none;touch-action:none;user-select:none;overflow:hidden}
#wrap{position:fixed;inset:0;display:grid;place-items:center;overflow:hidden;background:radial-gradient(900px 900px at 50% 30%,rgba(0,255,102,.12),rgba(2,5,8,1) 55%)}
canvas{display:block;touch-action:none}
#wrap::before{content:"";position:fixed;inset:0;pointer-events:none;background:linear-gradient(rgba(255,255,255,.03),rgba(0,0,0,.03));background-size:100% 4px;opacity:.32;mix-blend-mode:overlay;z-index:10}
#wrap::after{content:"";position:fixed;inset:-20px;pointer-events:none;background:radial-gradient(circle at 50% 42%,rgba(0,255,170,.10),transparent 58%),radial-gradient(circle at 50% 65%,rgba(0,0,0,0),rgba(0,0,0,.72) 70%);opacity:.9;z-index:11}
</style>
</head>
<body>
<div id="wrap"><canvas id="c"></canvas></div>
<script>
(function(){
"use strict";

const W=900,H=600;
const AW=W/2,AH=H;
const PLAYER_R=12;
const PLAYER_SPEED=220;
const PLAYER_FRICTION=0.88;
const RIFT_COOLDOWN=6;
const MIN_TELEGRAPH=0.35;

const canvas=document.getElementById("c");
const ctx=canvas.getContext("2d");

let scale=1,offX=0,offY=0;
function resize(){
  const vw=window.innerWidth,vh=window.innerHeight;
  const r=Math.min(vw/W,vh/H);
  scale=r;
  canvas.width=W*r;canvas.height=H*r;
  offX=(vw-W*r)/2;offY=(vh-H*r)/2;
  canvas.style.width=W*r+"px";canvas.style.height=H*r+"px";
  canvas.style.position="absolute";
  canvas.style.left=offX+"px";canvas.style.top=offY+"px";
}
window.addEventListener("resize",resize);
resize();

const keys={};
window.addEventListener("keydown",e=>{keys[e.code]=true;if(["Space","ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(e.code))e.preventDefault()});
window.addEventListener("keyup",e=>{keys[e.code]=false});

let touchL={active:false,id:-1,sx:0,sy:0,cx:0,cy:0};
let touchR={active:false,id:-1,sx:0,sy:0,cx:0,cy:0};
let touchRiftL=0,touchRiftR=0;

function screenToWorld(tx,ty){return{x:(tx-offX)/scale,y:(ty-offY)/scale}}

canvas.addEventListener("touchstart",e=>{
  e.preventDefault();
  for(let t of e.changedTouches){
    const p=screenToWorld(t.clientX,t.clientY);
    if(p.x<AW&&!touchL.active){touchL.active=true;touchL.id=t.identifier;touchL.sx=p.x;touchL.sy=p.y;touchL.cx=p.x;touchL.cy=p.y;
      const now=performance.now();if(now-touchRiftL<350&&state==="play")triggerRift();touchRiftL=now;
    }else if(p.x>=AW&&!touchR.active){touchR.active=true;touchR.id=t.identifier;touchR.sx=p.x;touchR.sy=p.y;touchR.cx=p.x;touchR.cy=p.y;
      const now=performance.now();if(now-touchRiftR<350&&state==="play")triggerRift();touchRiftR=now;
    }
  }
},{passive:false});
canvas.addEventListener("touchmove",e=>{
  e.preventDefault();
  for(let t of e.changedTouches){
    const p=screenToWorld(t.clientX,t.clientY);
    if(t.identifier===touchL.id){touchL.cx=p.x;touchL.cy=p.y}
    if(t.identifier===touchR.id){touchR.cx=p.x;touchR.cy=p.y}
  }
},{passive:false});
function endTouch(e){
  for(let t of e.changedTouches){
    if(t.identifier===touchL.id){touchL.active=false;touchL.id=-1}
    if(t.identifier===touchR.id){touchR.active=false;touchR.id=-1}
  }
}
canvas.addEventListener("touchend",endTouch);
canvas.addEventListener("touchcancel",endTouch);

let state="menu";
let score=0,bestScore=+(localStorage.getItem("neon-rift-best")||0);
let timeAlive=0,bestTime=+(localStorage.getItem("neon-rift-best-time")||0);
let riftCooldown=0;
let difficulty=1;
let particles=[];
let hazards=[];
let shakeTimer=0,shakeAmt=0;
let flashTimer=0;

const playerL={x:AW/2,y:AH*0.7,vx:0,vy:0,arena:0,alive:true,trail:[]};
const playerR={x:AW/2,y:AH*0.7,vx:0,vy:0,arena:1,alive:true,trail:[]};

let spawnTimerA=0,spawnTimerB=0;
let nearMissBonus=0,nearMissTimer=0;

function resetGame(){
  playerL.x=AW/2;playerL.y=AH*0.7;playerL.vx=0;playerL.vy=0;playerL.alive=true;playerL.trail=[];
  playerR.x=AW/2;playerR.y=AH*0.7;playerR.vx=0;playerR.vy=0;playerR.alive=true;playerR.trail=[];
  hazards=[];particles=[];score=0;timeAlive=0;riftCooldown=0;difficulty=1;
  spawnTimerA=0;spawnTimerB=0;nearMissBonus=0;nearMissTimer=0;
  shakeTimer=0;flashTimer=0;
}

function triggerRift(){
  if(riftCooldown>0||state!=="play")return;
  riftCooldown=RIFT_COOLDOWN;
  const tx=playerL.x,ty=playerL.y;
  playerL.x=playerR.x;playerL.y=playerR.y;
  playerR.x=tx;playerR.y=ty;
  const tvx=playerL.vx,tvy=playerL.vy;
  playerL.vx=playerR.vx;playerL.vy=playerR.vy;
  playerR.vx=tvx;playerR.vy=tvy;
  for(let i=0;i<20;i++){
    spawnParticle(playerL.x,playerL.y,0,"#8b5cff");
    spawnParticle(playerR.x,playerR.y,1,"#8b5cff");
  }
  flashTimer=0.15;
  playRiftSound();
}

function spawnParticle(x,y,arena,color){
  particles.push({x,y,arena,color,vx:(Math.random()-0.5)*200,vy:(Math.random()-0.5)*200,life:0.5+Math.random()*0.3,maxLife:0.8,r:2+Math.random()*3});
}

function spawnHazardDart(arena){
  const side=Math.floor(Math.random()*4);
  let sx,sy;
  const target=arena===0?playerL:playerR;
  if(side===0){sx=0;sy=Math.random()*AH}
  else if(side===1){sx=AW;sy=Math.random()*AH}
  else if(side===2){sx=Math.random()*AW;sy=0}
  else{sx=Math.random()*AW;sy=AH}
  const dx=target.x-sx,dy=target.y-sy;
  const len=Math.sqrt(dx*dx+dy*dy)||1;
  const baseSpeed=250+difficulty*30;
  const telegraphDur=Math.max(MIN_TELEGRAPH,0.6-difficulty*0.015);
  hazards.push({type:"dart",arena,x:sx,y:sy,dx:dx/len,dy:dy/len,speed:baseSpeed,
    phase:"telegraph",timer:telegraphDur,telegraphDur,
    endX:target.x,endY:target.y,life:3,r:6});
}

function spawnHazardLaser(arena){
  const horiz=Math.random()>0.5;
  const pos=20+Math.random()*(horiz?AH-40:AW-40);
  const telegraphDur=Math.max(MIN_TELEGRAPH,0.9-difficulty*0.02);
  hazards.push({type:"laser",arena,horiz,pos,
    phase:"telegraph",timer:telegraphDur,telegraphDur,
    activeDur:0.3+Math.min(difficulty*0.02,0.3),life:5});
}

function updatePlayers(dt){
  let lx=0,ly=0,rx=0,ry=0;
  if(keys["KeyW"]||keys["KeyUp"]&&false)ly=-1;
  if(keys["KeyS"])ly=1;
  if(keys["KeyA"])lx=-1;
  if(keys["KeyD"])lx=1;
  if(keys["KeyW"])ly=-1;

  if(keys["ArrowUp"])ry=-1;
  if(keys["ArrowDown"])ry=1;
  if(keys["ArrowLeft"])rx=-1;
  if(keys["ArrowRight"])rx=1;

  if(touchL.active){
    const tdx=touchL.cx-touchL.sx,tdy=touchL.cy-touchL.sy;
    const tlen=Math.sqrt(tdx*tdx+tdy*tdy);
    if(tlen>8){lx=tdx/tlen;ly=tdy/tlen}
  }
  if(touchR.active){
    const tdx=touchR.cx-touchR.sx,tdy=touchR.cy-touchR.sy;
    const tlen=Math.sqrt(tdx*tdx+tdy*tdy);
    if(tlen>8){rx=tdx/tlen;ry=tdy/tlen}
  }

  const llen=Math.sqrt(lx*lx+ly*ly)||1;
  const rlen=Math.sqrt(rx*rx+ry*ry)||1;
  if(lx||ly){playerL.vx+=lx/llen*PLAYER_SPEED*dt;playerL.vy+=ly/llen*PLAYER_SPEED*dt}
  if(rx||ry){playerR.vx+=rx/rlen*PLAYER_SPEED*dt;playerR.vy+=ry/rlen*PLAYER_SPEED*dt}

  playerL.vx*=PLAYER_FRICTION;playerL.vy*=PLAYER_FRICTION;
  playerR.vx*=PLAYER_FRICTION;playerR.vy*=PLAYER_FRICTION;

  playerL.x+=playerL.vx*dt;playerL.y+=playerL.vy*dt;
  playerR.x+=playerR.vx*dt;playerR.y+=playerR.vy*dt;

  playerL.x=Math.max(PLAYER_R,Math.min(AW-PLAYER_R,playerL.x));
  playerL.y=Math.max(PLAYER_R,Math.min(AH-PLAYER_R,playerL.y));
  playerR.x=Math.max(PLAYER_R,Math.min(AW-PLAYER_R,playerR.x));
  playerR.y=Math.max(PLAYER_R,Math.min(AH-PLAYER_R,playerR.y));

  playerL.trail.unshift({x:playerL.x,y:playerL.y,a:1});
  playerR.trail.unshift({x:playerR.x,y:playerR.y,a:1});
  if(playerL.trail.length>12)playerL.trail.pop();
  if(playerR.trail.length>12)playerR.trail.pop();
  for(let t of playerL.trail)t.a*=0.85;
  for(let t of playerR.trail)t.a*=0.85;
}

function updateHazards(dt){
  for(let i=hazards.length-1;i>=0;i--){
    const h=hazards[i];
    h.timer-=dt;
    if(h.type==="dart"){
      if(h.phase==="telegraph"&&h.timer<=0){h.phase="active";h.timer=3}
      if(h.phase==="active"){
        h.x+=h.dx*h.speed*dt;h.y+=h.dy*h.speed*dt;
        if(h.x<-30||h.x>AW+30||h.y<-30||h.y>AH+30){hazards.splice(i,1);continue}
      }
    }else if(h.type==="laser"){
      if(h.phase==="telegraph"&&h.timer<=0){h.phase="active";h.timer=h.activeDur}
      if(h.phase==="active"&&h.timer<=0){hazards.splice(i,1);continue}
    }
  }
}

function checkCollisions(){
  const players=[playerL,playerR];
  for(const h of hazards){
    if(h.phase!=="active")continue;
    const p=h.arena===0?playerL:playerR;

    if(h.type==="dart"){
      const dx=p.x-h.x,dy=p.y-h.y;
      const dist=Math.sqrt(dx*dx+dy*dy);
      if(dist<PLAYER_R+h.r){killPlayer(p,h);return true}
      if(dist<PLAYER_R+h.r+18){nearMissBonus+=5;nearMissTimer=1.5;playNearMiss()}
    }else if(h.type==="laser"){
      if(h.horiz){
        if(Math.abs(p.y-h.pos)<PLAYER_R+4){killPlayer(p,h);return true}
        if(Math.abs(p.y-h.pos)<PLAYER_R+20){nearMissBonus+=3;nearMissTimer=1.5;playNearMiss()}
      }else{
        if(Math.abs(p.x-h.pos)<PLAYER_R+4){killPlayer(p,h);return true}
        if(Math.abs(p.x-h.pos)<PLAYER_R+20){nearMissBonus+=3;nearMissTimer=1.5;playNearMiss()}
      }
    }
  }
  return false;
}

function killPlayer(p,h){
  p.alive=false;
  for(let i=0;i<30;i++)spawnParticle(p.x,p.y,p===playerL?0:1,"#ff2bd6");
  shakeTimer=0.4;shakeAmt=8;
  playDeathSound();
}

function updateParticles(dt){
  for(let i=particles.length-1;i>=0;i--){
    const p=particles[i];
    p.x+=p.vx*dt;p.y+=p.vy*dt;
    p.life-=dt;p.vx*=0.96;p.vy*=0.96;
    if(p.life<=0)particles.splice(i,1);
  }
}

function spawnHazards(dt){
  const baseIntervalA=Math.max(0.4,1.8-difficulty*0.1);
  const baseIntervalB=Math.max(0.8,3.5-difficulty*0.18);
  spawnTimerA-=dt;spawnTimerB-=dt;
  if(spawnTimerA<=0){spawnTimerA=baseIntervalA;spawnHazardDart(0);spawnHazardDart(1)}
  if(spawnTimerB<=0){spawnTimerB=baseIntervalB;spawnHazardLaser(0);spawnHazardLaser(1)}
}

let gridOffset=0;

function draw(){
  ctx.save();
  ctx.scale(scale,scale);

  if(shakeTimer>0){
    const sx=(Math.random()-0.5)*shakeAmt;const sy=(Math.random()-0.5)*shakeAmt;
    ctx.translate(sx,sy);
  }

  ctx.fillStyle="#020508";ctx.fillRect(0,0,W,H);

  drawArena(0,0);
  drawArena(1,AW);

  ctx.strokeStyle="rgba(0,255,102,0.5)";ctx.lineWidth=2;
  ctx.beginPath();ctx.moveTo(AW,0);ctx.lineTo(AW,H);ctx.stroke();
  ctx.strokeStyle="rgba(0,255,102,0.15)";ctx.lineWidth=1;
  ctx.beginPath();ctx.moveTo(AW-1,0);ctx.lineTo(AW-1,H);ctx.stroke();
  ctx.beginPath();ctx.moveTo(AW+1,0);ctx.lineTo(AW+1,H);ctx.stroke();

  if(flashTimer>0){
    ctx.fillStyle="rgba(139,92,255,"+(flashTimer/0.15*0.2).toFixed(2)+")";
    ctx.fillRect(0,0,W,H);
  }

  drawHUD();
  ctx.restore();
}

function drawArena(arenaIdx,ox){
  ctx.save();
  ctx.beginPath();ctx.rect(ox,0,AW,AH);ctx.clip();
  ctx.translate(ox,0);

  drawGrid();

  const p=arenaIdx===0?playerL:playerR;
  const color=arenaIdx===0?"#00ff66":"#00e5ff";

  for(const h of hazards){
    if(h.arena!==arenaIdx)continue;
    drawHazard(h,arenaIdx);
  }

  for(const pt of particles){
    if(pt.arena!==arenaIdx)continue;
    const a=pt.life/pt.maxLife;
    ctx.globalAlpha=a;
    ctx.fillStyle=pt.color;
    ctx.beginPath();ctx.arc(pt.x,pt.y,pt.r*a,0,Math.PI*2);ctx.fill();
    ctx.globalAlpha=1;
  }

  if(p.alive){
    for(let i=1;i<p.trail.length;i++){
      const t=p.trail[i];
      ctx.globalAlpha=t.a*0.3;
      ctx.fillStyle=color;
      ctx.beginPath();ctx.arc(t.x,t.y,PLAYER_R*(1-i/p.trail.length)*0.8,0,Math.PI*2);ctx.fill();
    }
    ctx.globalAlpha=1;

    ctx.shadowColor=color;ctx.shadowBlur=18;
    ctx.fillStyle=color;
    ctx.beginPath();ctx.arc(p.x,p.y,PLAYER_R,0,Math.PI*2);ctx.fill();
    ctx.shadowBlur=0;

    ctx.fillStyle="#020508";
    ctx.beginPath();ctx.arc(p.x,p.y,PLAYER_R*0.5,0,Math.PI*2);ctx.fill();

    ctx.strokeStyle=color;ctx.lineWidth=2;
    ctx.beginPath();ctx.arc(p.x,p.y,PLAYER_R+4+Math.sin(timeAlive*5)*2,0,Math.PI*2);ctx.stroke();
  }

  ctx.restore();
}

function drawGrid(){
  ctx.strokeStyle="rgba(0,255,102,0.06)";ctx.lineWidth=1;
  const step=40;
  const gy=gridOffset%step;
  for(let y=gy;y<AH;y+=step){ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(AW,y);ctx.stroke()}
  for(let x=0;x<AW;x+=step){ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,AH);ctx.stroke()}
}

function drawHazard(h){
  if(h.type==="dart"){
    if(h.phase==="telegraph"){
      const a=0.3+0.3*Math.sin(h.timer*20);
      ctx.strokeStyle="rgba(255,43,214,"+a.toFixed(2)+")";
      ctx.lineWidth=1;ctx.setLineDash([6,6]);
      ctx.beginPath();ctx.moveTo(h.x,h.y);
      ctx.lineTo(h.x+h.dx*500,h.y+h.dy*500);ctx.stroke();
      ctx.setLineDash([]);
      ctx.fillStyle="rgba(255,43,214,"+a.toFixed(2)+")";
      ctx.beginPath();ctx.arc(h.x,h.y,4,0,Math.PI*2);ctx.fill();
    }else{
      ctx.shadowColor="#ff2bd6";ctx.shadowBlur=12;
      ctx.fillStyle="#ff2bd6";
      ctx.beginPath();ctx.arc(h.x,h.y,h.r,0,Math.PI*2);ctx.fill();
      ctx.shadowBlur=0;
      ctx.fillStyle="#fff";
      ctx.beginPath();ctx.arc(h.x,h.y,h.r*0.4,0,Math.PI*2);ctx.fill();
    }
  }else if(h.type==="laser"){
    if(h.phase==="telegraph"){
      const a=0.15+0.25*Math.sin(h.timer*18);
      ctx.strokeStyle="rgba(255,204,51,"+a.toFixed(2)+")";
      ctx.lineWidth=2;ctx.setLineDash([8,8]);
      if(h.horiz){ctx.beginPath();ctx.moveTo(0,h.pos);ctx.lineTo(AW,h.pos);ctx.stroke()}
      else{ctx.beginPath();ctx.moveTo(h.pos,0);ctx.lineTo(h.pos,AH);ctx.stroke()}
      ctx.setLineDash([]);
    }else{
      const a=0.7+0.3*Math.sin(h.timer*30);
      ctx.shadowColor="#ffcc33";ctx.shadowBlur=20;
      ctx.strokeStyle="rgba(255,204,51,"+a.toFixed(2)+")";
      ctx.lineWidth=8;
      if(h.horiz){ctx.beginPath();ctx.moveTo(0,h.pos);ctx.lineTo(AW,h.pos);ctx.stroke()}
      else{ctx.beginPath();ctx.moveTo(h.pos,0);ctx.lineTo(h.pos,AH);ctx.stroke()}
      ctx.shadowBlur=0;
      ctx.strokeStyle="rgba(255,255,255,0.6)";ctx.lineWidth=2;
      if(h.horiz){ctx.beginPath();ctx.moveTo(0,h.pos);ctx.lineTo(AW,h.pos);ctx.stroke()}
      else{ctx.beginPath();ctx.moveTo(h.pos,0);ctx.lineTo(h.pos,AH);ctx.stroke()}
    }
  }
}

function drawHUD(){
  ctx.fillStyle="rgba(0,10,6,0.7)";
  ctx.fillRect(0,0,W,36);
  ctx.strokeStyle="rgba(0,255,102,0.3)";ctx.lineWidth=1;
  ctx.beginPath();ctx.moveTo(0,36);ctx.lineTo(W,36);ctx.stroke();

  ctx.font="bold 13px monospace";ctx.textBaseline="middle";

  ctx.fillStyle="#00ff66";ctx.textAlign="left";
  ctx.fillText("SCORE: "+Math.floor(score),12,18);

  ctx.fillStyle="#ffcc33";ctx.textAlign="left";
  ctx.fillText("BEST: "+Math.floor(bestScore),140,18);

  ctx.fillStyle="#c9ffe1";ctx.textAlign="center";
  ctx.fillText("TIME: "+timeAlive.toFixed(1)+"s",W/2,18);

  const tier=Math.floor(difficulty);
  ctx.fillStyle="#ff2bd6";ctx.textAlign="right";
  ctx.fillText("TIER: "+tier,W-140,18);

  if(riftCooldown>0){
    ctx.fillStyle="rgba(139,92,255,0.6)";ctx.textAlign="right";
    ctx.fillText("RIFT: "+riftCooldown.toFixed(1)+"s",W-12,18);
  }else{
    ctx.fillStyle="#8b5cff";ctx.textAlign="right";
    ctx.fillText("RIFT: READY",W-12,18);
  }

  if(nearMissTimer>0){
    const a=Math.min(1,nearMissTimer);
    ctx.globalAlpha=a;
    ctx.fillStyle="#ffcc33";ctx.textAlign="center";ctx.font="bold 16px monospace";
    ctx.fillText("NEAR MISS! +"+nearMissBonus,W/2,56);
    ctx.globalAlpha=1;
  }
}

function drawStartScreen(){
  ctx.save();ctx.scale(scale,scale);
  ctx.fillStyle="#020508";ctx.fillRect(0,0,W,H);

  drawGrid();
  ctx.save();ctx.translate(AW,0);drawGrid();ctx.restore();

  ctx.strokeStyle="rgba(0,255,102,0.3)";ctx.lineWidth=2;
  ctx.beginPath();ctx.moveTo(AW,0);ctx.lineTo(AW,H);ctx.stroke();

  ctx.textAlign="center";ctx.textBaseline="middle";

  ctx.shadowColor="#8b5cff";ctx.shadowBlur=30;
  ctx.fillStyle="#8b5cff";ctx.font="bold 42px monospace";
  ctx.fillText("NEON RIFT SPLIT",W/2,H*0.22);
  ctx.shadowBlur=0;

  ctx.fillStyle="#c9ffe1";ctx.font="16px monospace";
  ctx.fillText("Split-screen survival â€” control two avatars at once",W/2,H*0.32);

  ctx.fillStyle="#00ff66";ctx.font="bold 14px monospace";
  const cy=H*0.44;
  ctx.fillText("CONTROLS",W/2,cy);
  ctx.fillStyle="#c9ffe1";ctx.font="13px monospace";
  ctx.fillText("Left Avatar:  W A S D",W/2,cy+24);
  ctx.fillText("Right Avatar: Arrow Keys",W/2,cy+44);
  ctx.fillText("Rift Pulse:   Space (swap positions)",W/2,cy+64);
  ctx.fillText("Mobile: Dual touch joysticks / Double-tap for Rift",W/2,cy+84);

  ctx.fillStyle="rgba(0,10,6,0.6)";
  const bx=W/2-100,by=H*0.76-22,bw=200,bh=44;
  roundRect(ctx,bx,by,bw,bh,8,true,false);
  ctx.strokeStyle="#00ff66";ctx.lineWidth=2;
  roundRect(ctx,bx,by,bw,bh,8,false,true);
  ctx.shadowColor="#00ff66";ctx.shadowBlur=15;
  ctx.fillStyle="#00ff66";ctx.font="bold 18px monospace";
  ctx.fillText("START GAME",W/2,H*0.76);
  ctx.shadowBlur=0;

  if(bestScore>0){
    ctx.fillStyle="#ffcc33";ctx.font="13px monospace";
    ctx.fillText("Best Score: "+Math.floor(bestScore)+"  |  Best Time: "+bestTime.toFixed(1)+"s",W/2,H*0.86);
  }

  ctx.fillStyle="rgba(139,92,255,0.6)";ctx.font="11px monospace";
  ctx.fillText("If either avatar dies, the run ends. Good luck.",W/2,H*0.93);

  ctx.restore();
}

function drawGameOverScreen(){
  ctx.save();ctx.scale(scale,scale);
  ctx.fillStyle="rgba(2,5,8,0.85)";ctx.fillRect(0,0,W,H);

  ctx.textAlign="center";ctx.textBaseline="middle";

  ctx.shadowColor="#ff2bd6";ctx.shadowBlur=25;
  ctx.fillStyle="#ff2bd6";ctx.font="bold 36px monospace";
  ctx.fillText("GAME OVER",W/2,H*0.22);
  ctx.shadowBlur=0;

  ctx.fillStyle="#c9ffe1";ctx.font="16px monospace";
  ctx.fillText("Time Survived: "+timeAlive.toFixed(1)+"s",W/2,H*0.36);
  ctx.fillText("Score: "+Math.floor(score),W/2,H*0.42);

  if(score>=bestScore){
    ctx.fillStyle="#ffcc33";ctx.font="bold 16px monospace";
    ctx.fillText("NEW BEST SCORE!",W/2,H*0.50);
  }
  if(timeAlive>=bestTime){
    ctx.fillStyle="#ffcc33";ctx.font="bold 14px monospace";
    ctx.fillText("NEW BEST TIME!",W/2,H*0.55);
  }

  ctx.fillStyle="#ffcc33";ctx.font="13px monospace";
  ctx.fillText("Best: "+Math.floor(bestScore)+"  |  Best Time: "+bestTime.toFixed(1)+"s",W/2,H*0.63);

  ctx.fillStyle="rgba(0,10,6,0.6)";
  const bx=W/2-100,by=H*0.74-22,bw=200,bh=44;
  roundRect(ctx,bx,by,bw,bh,8,true,false);
  ctx.strokeStyle="#00ff66";ctx.lineWidth=2;
  roundRect(ctx,bx,by,bw,bh,8,false,true);
  ctx.shadowColor="#00ff66";ctx.shadowBlur=15;
  ctx.fillStyle="#00ff66";ctx.font="bold 18px monospace";
  ctx.fillText("PLAY AGAIN",W/2,H*0.74);
  ctx.shadowBlur=0;

  ctx.fillStyle="rgba(139,92,255,0.5)";ctx.font="11px monospace";
  ctx.fillText("Press Space or tap to restart",W/2,H*0.87);

  ctx.restore();
}

function roundRect(ctx,x,y,w,h,r,fill,stroke){
  ctx.beginPath();
  ctx.moveTo(x+r,y);ctx.lineTo(x+w-r,y);ctx.quadraticCurveTo(x+w,y,x+w,y+r);
  ctx.lineTo(x+w,y+h-r);ctx.quadraticCurveTo(x+w,y+h,x+w-r,y+h);
  ctx.lineTo(x+r,y+h);ctx.quadraticCurveTo(x,y+h,x,y+h-r);
  ctx.lineTo(x,y+r);ctx.quadraticCurveTo(x,y,x+r,y);
  ctx.closePath();
  if(fill)ctx.fill();if(stroke)ctx.stroke();
}

let audioCtx=null;
function ensureAudio(){if(!audioCtx){const AC=window.AudioContext||window.webkitAudioContext;audioCtx=new AC()}}

function playTone(freq,dur,type,vol){
  if(!audioCtx)return;
  const t=audioCtx.currentTime;
  const o=audioCtx.createOscillator();const g=audioCtx.createGain();
  o.type=type||"square";o.frequency.value=freq;
  g.gain.setValueAtTime(0.0001,t);g.gain.exponentialRampToValueAtTime(vol||0.08,t+0.01);
  g.gain.exponentialRampToValueAtTime(0.0001,t+dur);
  o.connect(g);g.connect(audioCtx.destination);o.start(t);o.stop(t+dur+0.02);
}
function playDeathSound(){playTone(120,0.4,"sawtooth",0.12);playTone(80,0.6,"square",0.08)}
function playRiftSound(){playTone(660,0.15,"sine",0.1);playTone(880,0.12,"triangle",0.08)}
function playNearMiss(){playTone(1200,0.06,"sine",0.05)}
function playStartSound(){playTone(440,0.1,"square",0.06);setTimeout(()=>playTone(660,0.1,"square",0.06),100);setTimeout(()=>playTone(880,0.15,"square",0.08),200)}

function handleStartInput(){
  ensureAudio();playStartSound();
  resetGame();state="play";
}

canvas.addEventListener("click",e=>{
  const p=screenToWorld(e.clientX,e.clientY);
  if(state==="menu"){
    const bx=W/2-100,by=H*0.76-22,bw=200,bh=44;
    if(p.x>=bx&&p.x<=bx+bw&&p.y>=by&&p.y<=by+bh){handleStartInput();return}
    handleStartInput();
  }else if(state==="over"){
    const bx=W/2-100,by=H*0.74-22,bw=200,bh=44;
    if(p.x>=bx&&p.x<=bx+bw&&p.y>=by&&p.y<=by+bh){handleStartInput();return}
  }
});

canvas.addEventListener("touchstart",e=>{
  if(state==="menu"){handleStartInput()}
  else if(state==="over"){handleStartInput()}
},{passive:true});

window.addEventListener("keydown",e=>{
  if(e.code==="Space"){
    if(state==="menu"){handleStartInput();return}
    if(state==="over"){handleStartInput();return}
    if(state==="play")triggerRift();
  }
});

let lastTime=0;
function loop(ts){
  const dt=Math.min((ts-lastTime)/1000,0.05);
  lastTime=ts;

  if(state==="menu"){
    gridOffset+=dt*20;
    drawStartScreen();
  }else if(state==="play"){
    gridOffset+=dt*40;
    timeAlive+=dt;
    score+=dt;
    difficulty=1+timeAlive/15;
    if(riftCooldown>0)riftCooldown=Math.max(0,riftCooldown-dt);
    if(shakeTimer>0){shakeTimer-=dt;shakeAmt*=0.92}
    if(flashTimer>0)flashTimer-=dt;
    if(nearMissTimer>0){nearMissTimer-=dt;if(nearMissTimer<=0){score+=nearMissBonus;nearMissBonus=0}}

    updatePlayers(dt);
    spawnHazards(dt);
    updateHazards(dt);
    updateParticles(dt);

    const died=checkCollisions();
    if(died){
      state="over";
      if(score>bestScore){bestScore=score;localStorage.setItem("neon-rift-best",Math.floor(bestScore))}
      if(timeAlive>bestTime){bestTime=timeAlive;localStorage.setItem("neon-rift-best-time",timeAlive.toFixed(1))}
      const runs=+(localStorage.getItem("neon-rift-total-runs")||0)+1;
      localStorage.setItem("neon-rift-total-runs",""+runs);
    }

    draw();
  }else if(state==="over"){
    updateParticles(Math.min(dt,0.03));
    draw();
    drawGameOverScreen();
  }

  requestAnimationFrame(loop);
}

requestAnimationFrame(ts=>{lastTime=ts;loop(ts)});
})();
</script>
</body>
</html>
